<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ScriptRunner</title>
  <!-- Avoid favicon 404 by embedding a data URL -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23007acc'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin:0; }
    #app { display: flex; height: 100vh; }
    .left { width: 30%; border-right:1px solid #ccc; padding:10px; overflow:auto; }
    .right { flex:1; padding:10px; overflow:auto; }
    pre { background:#f5f5f5; padding:8px; white-space:pre-wrap; }
    .muted { color:#666 }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #e0e0e0; padding:6px; text-align:left; }
    tr:hover { background:#fafafa; cursor:pointer; }
    .row { margin-bottom:8px; }
    .row label { display:block; font-weight:600; margin-bottom:4px; }
    .row input, .row select { width:100%; box-sizing:border-box; padding:6px; }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div id="app">
  <div class="left">
    <input v-model="filter" placeholder="Filter" style="width:100%;margin-bottom:8px;" />
    <div v-for="s in filteredScripts" :key="s.id" @click="selectScript(s)" style="padding:6px;cursor:pointer;border-bottom:1px solid #eee;">
      <strong>{{s.name}}</strong><br/><small class="muted">{{s.category}}</small>
    </div>
  </div>
  <div class="right" v-if="selected">
    <h2>{{selected.name}}</h2>
    <p>{{selected.description}}</p>
    <div>
      <div class="row" v-for="p in selected.parameters || []" :key="p.name">
        <label :for="'param_' + p.name">{{p.displayName || p.name}} <span v-if="p.required" class="muted">(required)</span></label>
        <template v-if="p.type===3">
          <input type="checkbox" :id="'param_' + p.name" v-model="paramValues[p.name]" />
        </template>
        <template v-else-if="p.type===4">
          <input type="datetime-local" :id="'param_' + p.name" v-model="paramValues[p.name]" />
        </template>
        <template v-else-if="p.type===5 && p.enumValues">
          <select :id="'param_' + p.name" v-model="paramValues[p.name]">
            <option v-for="opt in p.enumValues" :key="opt" :value="opt">{{opt}}</option>
          </select>
        </template>
        <template v-else-if="p.type===1 || p.type===2">
          <input type="number" :step="p.type===2 ? '0.01' : '1'" :id="'param_' + p.name" v-model.number="paramValues[p.name]" />
        </template>
        <template v-else>
          <input type="text" :id="'param_' + p.name" v-model="paramValues[p.name]" />
        </template>
        <div class="muted" v-if="p.helpText">{{p.helpText}}</div>
      </div>
    </div>
    <button @click="runScript" :disabled="running">Run</button>
    <div v-if="loading" class="spinner"></div>
    <button @click="cancel" v-if="lastExecId" :disabled="!canCancel">Cancel</button>
    <h3>Output</h3>
    <pre>{{output}}</pre>
    <div v-if="lastExecId">
      <a :href="`/api/history/${lastExecId}/output`" target="_blank">Download full output</a>
    </div>
    <div v-if="apiError" style="color:red;">{{apiError}}</div>
    <h3>History (recent)</h3>
    <table>
      <thead>
        <tr>
          <th>Script</th>
          <th>User</th>
          <th>Status</th>
          <th>Exit</th>
          <th>Started</th>
          <th>Finished</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="h in history" :key="h.executionId" @click="openHistory(h.executionId)">
          <td>{{h.scriptName}}</td>
          <td>{{h.ranByUser}}</td>
          <td>{{h.status}}</td>
          <td>{{h.exitCode}}</td>
          <td>{{h.startedAtUtc}}</td>
          <td>{{h.finishedAtUtc}}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="right" v-else>
    <h2>Select a script</h2>
  </div>
</div>
<script>
const app = Vue.createApp({
  data(){return{scripts:[], selected:null, filter:'', running:false, loading:false, output:'', history:[], lastExecId:null, canCancel:true, apiError:'', paramValues:{}}} ,
  computed:{
    filteredScripts(){
      const f = this.filter.toLowerCase();
      return this.scripts.filter(s=>!f|| s.name.toLowerCase().includes(f) || s.category.toLowerCase().includes(f));
    }
  },
  methods:{
    async loadScripts(){
      const r = await fetch('/api/scripts');
      this.scripts = await r.json();
    },
    async loadHistory(){
      const r = await fetch('/api/history');
      this.history = await r.json();
    },
    async selectScript(s){
      this.selected = s;
      // initialize defaults
      this.paramValues = {};
      for(const p of (s.parameters||[])){
        if(p.default) this.paramValues[p.name] = p.default;
        else if(p.type===3) this.paramValues[p.name] = false;
        else this.paramValues[p.name] = '';
      }
    },
    coerceForApi(value, type){
      // type: 0=string,1=int,2=decimal,3=bool,4=datetime,5=enum
      try{
        if(type===1) return value === '' || value === null ? null : parseInt(value,10);
        if(type===2) return value === '' || value === null ? null : parseFloat(value);
        if(type===3) return !!value;
        if(type===4){
          if(!value) return null;
          // Ensure ISO format
          const dt = new Date(value);
          return isNaN(dt.getTime()) ? value : dt.toISOString();
        }
        return value;
      }catch{ return value; }
    },
    async runScript(){
      if(!this.selected) return;
      this.loading=true; this.running=true; this.output='Running...'; this.apiError=''; this.lastExecId=null;
      try{
        const payload = {};
        for(const p of (this.selected.parameters||[])){
          const raw = this.paramValues[p.name];
          if(raw === '' || raw === null || typeof raw === 'undefined') continue;
          payload[p.name] = this.coerceForApi(raw, p.type);
        }
        const r = await fetch(`/api/scripts/${this.selected.id}/execute`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(r.status===202){
          const accepted = await r.json();
          this.lastExecId = accepted.executionId;
          this.pollStatus(accepted.executionId);
        } else if(r.ok){
          const rec = await r.json();
          this.output = this.formatOutput(rec);
        } else {
          const err = await r.json().catch(()=>({message:'Request failed'}));
          this.apiError = err.message || 'Request failed';
        }
      } catch(e){ this.apiError = 'Network error'; }
      finally{ this.loading=false; this.running=false; this.loadHistory(); }
    },
    async cancel(){
      if(!this.lastExecId) return;
      this.canCancel=false;
      await fetch(`/api/cancel/${this.lastExecId}`, { method:'POST' });
    },
    async pollStatus(id){
      const r = await fetch(`/api/history/${id}`);
      if(r.ok){
        const d = await r.json();
        if(d.status==='Queued' || d.status==='Running') { setTimeout(()=>this.pollStatus(id), 1500); }
        else { this.output = this.formatOutput(d); this.canCancel=false; this.loadHistory(); }
      }
    },
    async openHistory(id){
      const r = await fetch(`/api/history/${id}`);
      if(r.ok){
        const d = await r.json();
        this.output = this.formatOutput(d);
      }
    },
    formatOutput(rec){
      return `ExitCode: ${rec.exitCode}\nStatus: ${rec.status}\n\nStdOut:\n${rec.stdOut}\n\nStdErr:\n${rec.stdErr}`;
    }
  },
  mounted(){ this.loadScripts(); this.loadHistory(); }
});
app.mount('#app');
</script>
</body>
</html>