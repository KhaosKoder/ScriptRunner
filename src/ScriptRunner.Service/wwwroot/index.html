<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ScriptRunner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23007acc'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ESR%3C/text%3E%3C/svg%3E" />
<script src="/lib/vue.global.prod.js"></script>
<style>
  :root { --bg:#f8fafc; --pane:#ffffff; --border:#d9dee5; --accent:#0d6efd; --danger:#dc3545; --ok:#198754; --warn:#fd7e14; }
  * { box-sizing:border-box; }
  body,html { margin:0; padding:0; height:100%; font-family:Segoe UI, Arial, sans-serif; background:var(--bg); color:#1e293b; }
  #app { height:100vh; display:flex; flex-direction:column; }
  header { background:var(--pane); border-bottom:1px solid var(--border); padding:.5rem .75rem; display:flex; align-items:center; gap:.75rem; }
  header h1 { font-size:1rem; font-weight:600; margin:0; }
  .layout { flex:1; display:flex; min-height:0; }
  .sidebar { width:300px; background:var(--pane); border-right:1px solid var(--border); display:flex; flex-direction:column; }
  .sidebar .search { padding:.5rem; border-bottom:1px solid var(--border); }
  .sidebar input[type=text] { width:100%; padding:.4rem .55rem; font-size:.85rem; border:1px solid var(--border); border-radius:4px; }
  .script-list { flex:1; overflow:auto; padding:.5rem; }
  .script-item { padding:.45rem .55rem; border:1px solid transparent; border-radius:4px; cursor:pointer; font-size:.8rem; display:flex; flex-direction:column; gap:2px; }
  .script-item:hover { background:#eef2f7; }
  .script-item.active { background:#e0f2fe; border-color:#7dd3fc; }
  .script-path { font-size:.65rem; color:#64748b; }
  .content { flex:1; overflow:auto; padding:.75rem .9rem; display:flex; flex-direction:column; gap:.9rem; }
  .row { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
  button { background:var(--accent); color:#fff; border:1px solid var(--accent); padding:.5rem .9rem; font-size:.75rem; border-radius:4px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:.4rem; }
  button:disabled { opacity:.45; cursor:not-allowed; }
  .params { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:.6rem; }
  .param { background:var(--pane); border:1px solid var(--border); padding:.55rem .6rem; border-radius:6px; display:flex; flex-direction:column; gap:4px; }
  .param label { font-size:.65rem; font-weight:600; text-transform:uppercase; letter-spacing:.5px; }
  .param input, .param select { padding:.4rem .45rem; font-size:.75rem; border:1px solid var(--border); border-radius:4px; width:100%; background:#f8fafc; }
  .status-badge { font-size:.6rem; font-weight:600; padding:.25rem .5rem; border-radius:12px; display:inline-flex; align-items:center; gap:.3rem; background:#e2e8f0; color:#334155; }
  .status-Succeeded { background:#dcfce7; color:#166534; }
  .status-Failed { background:#fee2e2; color:#991b1b; }
  .status-Running { background:#e0e7ff; color:#3730a3; }
  .status-Queued { background:#f0f9ff; color:#075985; }
  .panes { display:flex; flex-direction:column; gap:.75rem; }
  .pane-tabs { display:flex; gap:.4rem; flex-wrap:wrap; }
  .pane-tab { padding:.4rem .7rem; font-size:.7rem; border:1px solid var(--border); background:var(--pane); border-radius:4px; cursor:pointer; }
  .pane-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  .pane-body { background:#0f172a; color:#e2e8f0; font-family:Consolas,monospace; font-size:.65rem; padding:.75rem .8rem; border-radius:6px; min-height:180px; white-space:pre-wrap; line-height:1.2; }
  .pane-body.errors { background:#2d1b1b; color:#f8d7da; }
  table.history { width:100%; border-collapse:collapse; font-size:.65rem; }
  table.history th, table.history td { padding:.4rem .5rem; border:1px solid #33415533; text-align:left; }
  table.history th { background:#f1f5f9; font-weight:600; }
  .link-btn { background:#475569; border-color:#475569; }
  .empty { font-size:.7rem; color:#64748b; }
  .toast { position:fixed; right:12px; bottom:12px; background:#1e293b; color:#fff; padding:.6rem .8rem; font-size:.7rem; border-radius:4px; box-shadow:0 2px 6px #0003; display:none; }
  .toast.show { display:block; }
  .error-banner { background:#fee2e2; color:#7f1d1d; padding:.5rem .7rem; font-size:.7rem; }
  footer { font-size:.6rem; padding:.4rem .7rem; color:#64748b; text-align:right; }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>ScriptRunner</h1>
    <button @click="reloadAll" :disabled="busy">Reload</button>
    <button @click="openGlobalHistory" :disabled="busy">History</button>
    <span v-if="execStatus" :class="'status-badge status-'+execStatus.status">{{ execStatus.status }}</span>
    <span style="margin-left:auto;font-size:.6rem;color:#64748b;">{{ traceId }}</span>
  </header>
  <div v-if="loadError" class="error-banner">{{ loadError }}</div>
  <div class="layout" v-else>
    <aside class="sidebar">
      <div class="search"><input type="text" v-model="filter" placeholder="Search scripts" /></div>
      <div class="script-list">
        <div v-for="s in filteredScripts" :key="s.id" @click="selectScript(s)" :class="['script-item', activeScript && activeScript.id===s.id ? 'active':'']">
          <strong>{{ s.name }}</strong>
          <div class="script-path" v-if="s.sourcePath">{{ s.sourcePath }}</div>
        </div>
        <div v-if="!filteredScripts.length" class="empty">No scripts.</div>
      </div>
    </aside>
    <main class="content">
      <template v-if="activeScript">
        <div class="row">
          <h2 style="margin:0;font-size:1rem;flex:1;">{{ activeScript.name }}</h2>
          <button @click="runScript" :disabled="running">Run</button>
          <div v-if="running" class="status-badge status-Running">Running...</div>
          <div v-if="lastRun" :class="'status-badge status-'+lastRun.status">Last: {{ lastRun.status }}</div>
        </div>
        <div class="params" v-if="(activeScript.parameters||[]).length">
          <div class="param" v-for="p in activeScript.parameters" :key="p.name">
            <label>{{ p.displayName || p.name }}<span v-if="p.required" style="color:#dc2626"> *</span></label>
            <template v-if="p.type===3">
              <input type="checkbox" v-model="paramValues[p.name]" />
            </template>
            <template v-else-if="p.type===4">
              <input type="datetime-local" v-model="paramValues[p.name]" />
            </template>
            <template v-else-if="p.type===5 && p.enumValues">
              <select v-model="paramValues[p.name]">
                <option v-for="opt in p.enumValues" :value="opt">{{ opt }}</option>
              </select>
            </template>
            <template v-else-if="p.type===1 || p.type===2">
              <input type="number" :step="p.type===2?'0.01':'1'" v-model="paramValues[p.name]" />
            </template>
            <template v-else>
              <input type="text" v-model="paramValues[p.name]" />
            </template>
            <div v-if="p.helpText" style="font-size:.6rem;color:#64748b;">{{ p.helpText }}</div>
          </div>
        </div>
        <div class="panes">
          <div class="pane-tabs">
            <div class="pane-tab" :class="{active:tab==='out'}" @click="tab='out'">Output</div>
            <div class="pane-tab" :class="{active:tab==='err'}" @click="tab='err'">Errors</div>
            <div class="pane-tab" :class="{active:tab==='hist'}" @click="tab='hist'">History</div>
          </div>
          <div v-if="tab==='out'" class="pane-body">{{ stdOut || 'No output.' }}</div>
          <div v-if="tab==='err'" class="pane-body errors">{{ stdErr || 'No errors.' }}</div>
          <div v-if="tab==='hist'" class="pane-body" style="background:#ffffff;color:#0f172a;">
            <table class="history" v-if="scriptHistory.length">
              <thead><tr><th>Started</th><th>Finished</th><th>Status</th><th>Exit</th><th>User</th><th></th></tr></thead>
              <tbody>
                <tr v-for="h in scriptHistory" :key="h.executionId">
                  <td>{{ h.startedAtUtc }}</td>
                  <td>{{ h.finishedAtUtc }}</td>
                  <td><span :class="'status-badge status-'+h.status">{{ h.status }}</span></td>
                  <td>{{ h.exitCode }}</td>
                  <td>{{ h.ranByUser }}</td>
                  <td><button class="link-btn" @click="openExecution(h.executionId)" style="padding:.25rem .5rem;font-size:.6rem;">View</button></td>
                </tr>
              </tbody>
            </table>
            <div v-else class="empty">No history.</div>
          </div>
        </div>
      </template>
      <template v-else>
        <p style="margin:0;font-size:.85rem;">Select a script to begin.</p>
      </template>
    </main>
  </div>
  <div :class="['toast', toast.show?'show':'']">{{ toast.msg }}</div>
  <footer>ScriptRunner</footer>
</div>
<script>
const { createApp } = Vue;
createApp({
  data(){
    return {
      loadError: null,
      scripts: [],
      filter: '',
      activeScript: null,
      paramValues: {},
      running: false,
      stdOut: '',
      stdErr: '',
      execStatus: null,
      scriptHistory: [],
      lastRun: null,
      tab: 'out',
      toast: { show:false, msg:'' },
      busy:false,
      traceId:''
    }
  },
  computed:{
    filteredScripts(){ const f=this.filter.trim().toLowerCase(); if(!f) return this.scripts; return this.scripts.filter(s=> (s.name||'').toLowerCase().includes(f) || (s.sourcePath||'').toLowerCase().includes(f)); }
  },
  mounted(){ this.loadScripts(); },
  methods:{
    async reloadAll(){ this.busy=true; try{ await this.loadScripts(); if(this.activeScript) await this.loadScriptHistory(this.activeScript.id); } finally { this.busy=false; }},
    async loadScripts(){ try{ const r=await fetch('/api/scripts'); if(!r.ok){ this.loadError='Failed scripts'; return; } this.traceId=r.headers.get('X-Correlation-ID')||''; this.scripts=await r.json(); } catch(e){ this.loadError='Network error'; }},
    selectScript(s){ this.activeScript=s; this.execStatus=null; this.stdOut=''; this.stdErr=''; this.paramValues={}; (s.parameters||[]).forEach(p=>{ if(p.default!==undefined) this.paramValues[p.name]=p.default; else if(p.type===3) this.paramValues[p.name]=false; else this.paramValues[p.name]=''; }); this.loadScriptHistory(s.id); this.fetchLastRun(s.id); },
    async fetchLastRun(id){ try{ const r=await fetch(`/api/history/script/${id}`); if(r.ok){ const list=await r.json(); this.lastRun=list[0]||null; } }catch{} },
    async loadScriptHistory(id){ try{ const r=await fetch(`/api/history/script/${id}`); if(r.ok){ this.scriptHistory=await r.json(); } }catch{} },
    coerce(value,type){ try{ if(type===1) return value===''||value==null? null: parseInt(value,10); if(type===2) return value===''||value==null? null: parseFloat(value); if(type===3) return !!value; if(type===4){ if(!value) return null; const dt=new Date(value); return isNaN(dt.getTime())? value: dt.toISOString(); } return value; }catch{ return value; } },
    async runScript(){ if(!this.activeScript) return; this.running=true; this.execStatus=null; this.stdOut=''; this.stdErr=''; try{ const payload={}; for(const p of (this.activeScript.parameters||[])){ const raw=this.paramValues[p.name]; if(raw===''||raw===null||raw===undefined) continue; payload[p.name]=this.coerce(raw,p.type); } const r=await fetch(`/api/scripts/${this.activeScript.id}/execute`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(r.status===202){ const a=await r.json(); this.pollStatus(a.executionId); this.flash('Queued'); } else { this.flash('Execute failed'); } } catch { this.flash('Network error'); } finally { this.running=false; } },
    async pollStatus(id){ try{ const r=await fetch(`/api/history/${id}`); if(!r.ok) return; const d=await r.json(); this.execStatus=d; this.stdOut=d.stdOut||''; this.stdErr=d.stdErr||''; if(d.status==='Queued'||d.status==='Running'){ setTimeout(()=>this.pollStatus(id),1200); } else { this.loadScriptHistory(this.activeScript.id); this.fetchLastRun(this.activeScript.id); this.flash('Finished '+d.status); } }catch{} },
    async openExecution(id){ try{ const r=await fetch(`/api/history/${id}`); if(r.ok){ const d=await r.json(); this.execStatus=d; this.stdOut=d.stdOut||''; this.stdErr=d.stdErr||''; this.tab='out'; } }catch{} },
    async openGlobalHistory(){ try{ const r=await fetch('/api/history'); if(r.ok){ this.scriptHistory=await r.json(); this.activeScript={ id:'__global', name:'Global History', parameters:[] }; this.execStatus=null; this.stdOut=''; this.stdErr=''; this.lastRun=null; this.tab='hist'; } }catch{} },
    flash(msg){ this.toast.msg=msg; this.toast.show=true; setTimeout(()=>{ this.toast.show=false; },2500); }
  }
}).mount('#app');
</script>
</body>
</html>